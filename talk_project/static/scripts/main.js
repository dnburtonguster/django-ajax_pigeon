//US area codes hashmap/dictionary
var area_code = {};

area_code['201'] = 'NJ'
area_code['202'] = 'DC'
area_code['203'] = 'CT'
area_code['204'] = 'MB'
area_code['205'] = 'AL'
area_code['206'] = 'WA'
area_code['207'] = 'ME'
area_code['208'] = 'ID'
area_code['209'] = 'CA'
area_code['210'] = 'TX'
area_code['212'] = 'NY'
area_code['213'] = 'CA'
area_code['214'] = 'TX'
area_code['215'] = 'PA'
area_code['216'] = 'OH'
area_code['217'] = 'IL'
area_code['218'] = 'MN'
area_code['219'] = 'IN'
area_code['224'] = 'IL'
area_code['225'] = 'LA'
area_code['226'] = 'ON'
area_code['228'] = 'MS'
area_code['229'] = 'GA'
area_code['231'] = 'MI'
area_code['234'] = 'OH'
area_code['236'] = 'BC'
area_code['239'] = 'FL'
area_code['240'] = 'MD'
area_code['248'] = 'MI'
area_code['250'] = 'BC'
area_code['251'] = 'AL'
area_code['252'] = 'NC'
area_code['253'] = 'WA'
area_code['254'] = 'TX'
area_code['256'] = 'AL'
area_code['260'] = 'IN'
area_code['262'] = 'WI'
area_code['267'] = 'PA'
area_code['269'] = 'MI'
area_code['270'] = 'KY'
area_code['276'] = 'VA'
area_code['278'] = 'MI'
area_code['281'] = 'TX'
area_code['283'] = 'OH'
area_code['289'] = 'ON'
area_code['301'] = 'MD'
area_code['302'] = 'DE'
area_code['303'] = 'CO'
area_code['304'] = 'WV'
area_code['305'] = 'FL'
area_code['306'] = 'SK'
area_code['307'] = 'WY'
area_code['308'] = 'NE'
area_code['309'] = 'IL'
area_code['310'] = 'CA'
area_code['312'] = 'IL'
area_code['313'] = 'MI'
area_code['314'] = 'MO'
area_code['315'] = 'NY'
area_code['316'] = 'KS'
area_code['317'] = 'IN'
area_code['318'] = 'LA'
area_code['319'] = 'IA'
area_code['320'] = 'MN'
area_code['321'] = 'FL'
area_code['323'] = 'CA'
area_code['325'] = 'TX'
area_code['330'] = 'OH'
area_code['331'] = 'IL'
area_code['334'] = 'AL'
area_code['336'] = 'NC'
area_code['337'] = 'LA'
area_code['339'] = 'MA'
area_code['340'] = 'VI'
area_code['341'] = 'CA'
area_code['343'] = 'ON'
area_code['347'] = 'NY'
area_code['351'] = 'MA'
area_code['352'] = 'FL'
area_code['360'] = 'WA'
area_code['361'] = 'TX'
area_code['365'] = 'ON'
area_code['369'] = 'CA'
area_code['380'] = 'OH'
area_code['385'] = 'UT'
area_code['386'] = 'FL'
area_code['401'] = 'RI'
area_code['402'] = 'NE'
area_code['403'] = 'AB'
area_code['404'] = 'GA'
area_code['405'] = 'OK'
area_code['406'] = 'MT'
area_code['407'] = 'FL'
area_code['408'] = 'CA'
area_code['409'] = 'TX'
area_code['410'] = 'MD'
area_code['412'] = 'PA'
area_code['413'] = 'MA'
area_code['414'] = 'WI'
area_code['415'] = 'CA'
area_code['416'] = 'ON'
area_code['417'] = 'MO'
area_code['418'] = 'QC'
area_code['419'] = 'OH'
area_code['423'] = 'TN'
area_code['424'] = 'CA'
area_code['425'] = 'WA'
area_code['430'] = 'TX'
area_code['431'] = 'MB'
area_code['432'] = 'TX'
area_code['434'] = 'VA'
area_code['435'] = 'UT'
area_code['437'] = 'ON'
area_code['438'] = 'QC'
area_code['440'] = 'OH'
area_code['442'] = 'CA'
area_code['443'] = 'MD'
area_code['450'] = 'QC'
area_code['464'] = 'IL'
area_code['469'] = 'TX'
area_code['470'] = 'GA'
area_code['475'] = 'CT'
area_code['478'] = 'GA'
area_code['479'] = 'AR'
area_code['480'] = 'AZ'
area_code['481'] = 'QC'
area_code['484'] = 'PA'
area_code['501'] = 'AR'
area_code['502'] = 'KY'
area_code['503'] = 'OR'
area_code['504'] = 'LA'
area_code['505'] = 'NM'
area_code['506'] = 'NB'
area_code['507'] = 'MN'
area_code['508'] = 'MA'
area_code['509'] = 'WA'
area_code['510'] = 'CA'
area_code['512'] = 'TX'
area_code['513'] = 'OH'
area_code['514'] = 'QC'
area_code['515'] = 'IA'
area_code['516'] = 'NY'
area_code['517'] = 'MI'
area_code['518'] = 'NY'
area_code['519'] = 'ON'
area_code['520'] = 'AZ'
area_code['530'] = 'CA'
area_code['539'] = 'OK'
area_code['540'] = 'VA'
area_code['541'] = 'OR'
area_code['548'] = 'ON'
area_code['551'] = 'NJ'
area_code['557'] = 'MO'
area_code['559'] = 'CA'
area_code['561'] = 'FL'
area_code['562'] = 'CA'
area_code['563'] = 'IA'
area_code['564'] = 'WA'
area_code['567'] = 'OH'
area_code['570'] = 'PA'
area_code['571'] = 'VA'
area_code['573'] = 'MO'
area_code['574'] = 'IN'
area_code['575'] = 'NM'
area_code['579'] = 'QC'
area_code['580'] = 'OK'
area_code['585'] = 'NY'
area_code['586'] = 'MI'
area_code['587'] = 'AB'
area_code['601'] = 'MS'
area_code['602'] = 'AZ'
area_code['603'] = 'NH'
area_code['604'] = 'BC'
area_code['605'] = 'SD'
area_code['606'] = 'KY'
area_code['607'] = 'NY'
area_code['608'] = 'WI'
area_code['609'] = 'NJ'
area_code['610'] = 'PA'
area_code['612'] = 'MN'
area_code['613'] = 'ON'
area_code['614'] = 'OH'
area_code['615'] = 'TN'
area_code['616'] = 'MI'
area_code['617'] = 'MA'
area_code['618'] = 'IL'
area_code['619'] = 'CA'
area_code['620'] = 'KS'
area_code['623'] = 'AZ'
area_code['626'] = 'CA'
area_code['627'] = 'CA'
area_code['628'] = 'CA'
area_code['630'] = 'IL'
area_code['631'] = 'NY'
area_code['636'] = 'MO'
area_code['639'] = 'SK'
area_code['641'] = 'IA'
area_code['646'] = 'NY'
area_code['647'] = 'ON'
area_code['650'] = 'CA'
area_code['651'] = 'MN'
area_code['657'] = 'CA'
area_code['660'] = 'MO'
area_code['661'] = 'CA'
area_code['662'] = 'MS'
area_code['669'] = 'CA'
area_code['670'] = 'MP'
area_code['671'] = 'GU'
area_code['678'] = 'GA'
area_code['679'] = 'MI'
area_code['681'] = 'WV'
area_code['682'] = 'TX'
area_code['689'] = 'FL'
area_code['701'] = 'ND'
area_code['702'] = 'NV'
area_code['703'] = 'VA'
area_code['704'] = 'NC'
area_code['705'] = 'ON'
area_code['706'] = 'GA'
area_code['707'] = 'CA'
area_code['708'] = 'IL'
area_code['709'] = 'NL'
area_code['712'] = 'IA'
area_code['713'] = 'TX'
area_code['714'] = 'CA'
area_code['715'] = 'WI'
area_code['716'] = 'NY'
area_code['717'] = 'PA'
area_code['718'] = 'NY'
area_code['719'] = 'CO'
area_code['720'] = 'CO'
area_code['724'] = 'PA'
area_code['727'] = 'FL'
area_code['731'] = 'TN'
area_code['732'] = 'NJ'
area_code['734'] = 'MI'
area_code['737'] = 'TX'
area_code['740'] = 'OH'
area_code['747'] = 'CA'
area_code['754'] = 'FL'
area_code['757'] = 'VA'
area_code['760'] = 'CA'
area_code['762'] = 'GA'
area_code['763'] = 'MN'
area_code['764'] = 'CA'
area_code['765'] = 'IN'
area_code['769'] = 'MS'
area_code['770'] = 'GA'
area_code['772'] = 'FL'
area_code['773'] = 'IL'
area_code['774'] = 'MA'
area_code['775'] = 'NV'
area_code['778'] = 'BC'
area_code['779'] = 'IL'
area_code['780'] = 'AB'
area_code['781'] = 'MA'
area_code['782'] = 'NS'
area_code['785'] = 'KS'
area_code['786'] = 'FL'
area_code['787'] = 'PR'
area_code['801'] = 'UT'
area_code['802'] = 'VT'
area_code['803'] = 'SC'
area_code['804'] = 'VA'
area_code['805'] = 'CA'
area_code['806'] = 'TX'
area_code['807'] = 'ON'
area_code['808'] = 'HI'
area_code['810'] = 'MI'
area_code['812'] = 'IN'
area_code['813'] = 'FL'
area_code['814'] = 'PA'
area_code['815'] = 'IL'
area_code['816'] = 'MO'
area_code['817'] = 'TX'
area_code['818'] = 'CA'
area_code['819'] = 'QC'
area_code['825'] = 'AB'
area_code['828'] = 'NC'
area_code['830'] = 'TX'
area_code['831'] = 'CA'
area_code['832'] = 'TX'
area_code['835'] = 'PA'
area_code['843'] = 'SC'
area_code['845'] = 'NY'
area_code['847'] = 'IL'
area_code['848'] = 'NJ'
area_code['850'] = 'FL'
area_code['856'] = 'NJ'
area_code['857'] = 'MA'
area_code['858'] = 'CA'
area_code['859'] = 'KY'
area_code['860'] = 'CT'
area_code['862'] = 'NJ'
area_code['863'] = 'FL'
area_code['864'] = 'SC'
area_code['865'] = 'TN'
area_code['867'] = 'YT'
area_code['870'] = 'AR'
area_code['872'] = 'IL'
area_code['873'] = 'QC'
area_code['878'] = 'PA'
area_code['901'] = 'TN'
area_code['902'] = 'NS'
area_code['903'] = 'TX'
area_code['904'] = 'FL'
area_code['905'] = 'ON'
area_code['906'] = 'MI'
area_code['907'] = 'AK'
area_code['908'] = 'NJ'
area_code['909'] = 'CA'
area_code['910'] = 'NC'
area_code['912'] = 'GA'
area_code['913'] = 'KS'
area_code['914'] = 'NY'
area_code['915'] = 'TX'
area_code['916'] = 'CA'
area_code['917'] = 'NY'
area_code['918'] = 'OK'
area_code['919'] = 'NC'
area_code['920'] = 'WI'
area_code['925'] = 'CA'
area_code['927'] = 'FL'
area_code['928'] = 'AZ'
area_code['931'] = 'TN'
area_code['935'] = 'CA'
area_code['936'] = 'TX'
area_code['937'] = 'OH'
area_code['939'] = 'PR'
area_code['940'] = 'TX'
area_code['941'] = 'FL'
area_code['947'] = 'MI'
area_code['949'] = 'CA'
area_code['951'] = 'CA'
area_code['952'] = 'MN'
area_code['954'] = 'FL'
area_code['956'] = 'TX'
area_code['957'] = 'NM'
area_code['959'] = 'CT'
area_code['970'] = 'CO'
area_code['971'] = 'OR'
area_code['972'] = 'TX'
area_code['973'] = 'NJ'
area_code['975'] = 'MO'
area_code['978'] = 'MA'
area_code['979'] = 'TX'
area_code['980'] = 'NC'
area_code['984'] = 'NC'
area_code['985'] = 'LA'
area_code['989'] = 'MI'

//function to map states to text (client-side only)
//TOdo - persist data server-side
function TextToCode(text) {
    for (i=0;i<text.length;i++) {
        var t = text.slice(0,3);
        var state = area_code[t]
    //return state
    }
    return state
}
////////////////////////
$(function() {

    load_posts()

    // Load all posts on page load
    function load_posts() {
        $.ajax({
            url : "api/v1/posts/", // the endpoint
            type : "GET", // http method
            // handle a successful response
            success : function(json) {
                for (var i = 0; i < json.length; i++) {
                    dateString = convert_to_readable_date(json[i].created)
                    $("#talk").prepend("<li id='post-"+json[i].id+"'><strong>"+clean_text(json[i].text)+
                        "</span> "+TextToCode(json[i].text)+" </strong> - <em> "+ //+json[i].author+"</em> - <span> "+dateString+
                        "</span> - <a id='delete-post-"+json[i].id+"'>delete me</a></li>");
                }
            },
            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    };

    // convert ugly date to human readable date
    function convert_to_readable_date(date_time_string) {
        var newDate = moment(date_time_string).format('MM/DD/YYYY, h:mm:ss a')
        return newDate
    }

    // convert text field to modified text fields
    function clean_texts(texts) {
        var texts = "placeholder"
        return texts
    }


    function clean_text(text) {
        var phoneRe = new RegExp(/\(?[2-9][0-9]{2}\)?[-. ]?[2-9][0-9]{2}[-. ]?[0-9]{4}/g);
        var matches = [];
        var match = text.match(phoneRe);
        for (i=0;i<match.length;i++){
            var digits = match[i].match(/\d+/g);
            var digits = Array.prototype.join.call(digits,'');
            matches.push(digits)
        }
        return matches;
    }



    // Submit post on submit
    $('#post-form').on('submit', function(event){
        event.preventDefault();
        console.log("form submitted!")  // sanity check
        create_post();
    });

    // Delete post on click
    $("#talk").on('click', 'a[id^=delete-post-]', function(){
        var post_primary_key = $(this).attr('id').split('-')[2];
        console.log(post_primary_key) // sanity check
        delete_post(post_primary_key);
    });

    // AJAX for posting
    function create_post() {
        console.log("create post is working!") // sanity check
        $.ajax({
            url : "api/v1/posts/", // the endpoint
            type : "POST", // http method
            data : { text : $('#post-text').val(), author: $('#user').text()}, // data sent with the post request
            // handle a successful response
            success : function(json) {
                $('#post-text').val(''); // remove the value from the input
                console.log(json); // log the returned json to the console
                dateString = convert_to_readable_date(json.created)
                text = clean_text(json.text)
                code = TextToCode(json.text)
                $("#talk").prepend("<li id='post-"+json.id+"'><strong>"+text+"</strong> - <em> "+" - "+code+
                    //json.author+"</em> - <span> "+dateString+
                    " </span> - <a id='delete-post-"+json.id+"'>delete me</a></li>");
                console.log("success"); // another sanity check
            },
            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    };

    // AJAX for deleting
    function delete_post(post_primary_key){
        if (confirm('are you sure you want to remove this post?')==true){
            $.ajax({
                url : "api/v1/posts/"+post_primary_key, // the endpoint
                type : "DELETE", // http method
                data : { postpk : post_primary_key }, // data sent with the delete request
                success : function(json) {
                    // hide the post
                  $('#post-'+post_primary_key).hide(); // hide the post on success
                  console.log("post deletion successful");
                },

                error : function(xhr,errmsg,err) {
                    // Show an error
                    $('#results').html("<div class='alert-box alert radius' data-alert>"+
                    "Oops! We have encountered an error. <a href='#' class='close'>&times;</a></div>"); // add error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
            });
        } else {
            return false;
        }
    };


    // This function gets cookie with a given name
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    /*
    The functions below will create a header with csrftoken
    */

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    function sameOrigin(url) {
        // test that a given url is a same-origin URL
        // url could be relative or scheme relative or absolute
        var host = document.location.host; // host + port
        var protocol = document.location.protocol;
        var sr_origin = '//' + host;
        var origin = protocol + sr_origin;
        // Allow absolute or scheme relative URLs to same origin
        return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
            (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
            // or any other URL that isn't scheme relative or absolute i.e relative.
            !(/^(\/\/|http:|https:).*/.test(url));
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                // Send the token to same-origin, relative URLs only.
                // Send the token only if the method warrants CSRF protection
                // Using the CSRFToken value acquired earlier
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

});
